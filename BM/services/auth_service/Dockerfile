# ------------------
# Giai Ä‘oáº¡n 1: Build (CÃ i Ä‘áº·t dependencies)
# ------------------
# DÃ¹ng image Node.js 18 (Alpine lÃ  báº£n siÃªu nháº¹)
FROM node:18-alpine AS builder

# Äáº·t thÆ° má»¥c lÃ m viá»‡c bÃªn trong container
WORKDIR /app

# Copy file package.json vÃ  package-lock.json
COPY package*.json ./

# CÃ i Ä‘áº·t táº¥t cáº£ dependencies (bao gá»“m devDependencies Ä‘á»ƒ build)
RUN npm install

# Copy toÃ n bá»™ code (thÆ° má»¥c src, prisma, .env...) vÃ o
COPY . .

# ğŸ’¡ Cháº¡y Prisma Generate (Ráº¥t quan trá»ng cho K8s)
# BÆ°á»›c nÃ y Ä‘á»ƒ táº¡o Prisma Client cho mÃ´i trÆ°á»ng Linux
RUN npx prisma generate

# ------------------
# Giai Ä‘oáº¡n 2: Production (Cháº¡y app)
# ------------------
# DÃ¹ng láº¡i image Node.js 18 (hoáº·c má»™t image slim hÆ¡n)
FROM node:18-alpine

WORKDIR /app

# Copy láº¡i file package Ä‘á»ƒ cÃ i Ä‘áº·t production
COPY package*.json ./

# ğŸ’¡ Chá»‰ cÃ i Ä‘áº·t dependencies cho production (nháº¹ hÆ¡n)
RUN npm install --production

# Copy code Ä‘Ã£ build vÃ  node_modules tá»« giai Ä‘oáº¡n "builder"
# Copy thÆ° má»¥c "dist" náº¿u báº¡n cÃ³ bÆ°á»›c build (TypeScript)
# COPY --from=builder /app/dist ./dist

# Copy code "src" náº¿u báº¡n cháº¡y JS trá»±c tiáº¿p
COPY --from=builder /app/src ./src

# Copy Prisma schema vÃ  client Ä‘Ã£ Ä‘Æ°á»£c generate
COPY --from=builder /app/prisma ./prisma
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/.env .env   

# Láº¥y cá»•ng tá»« biáº¿n mÃ´i trÆ°á»ng (máº·c Ä‘á»‹nh lÃ  8081)
ENV PORT=8081

# Má»Ÿ cá»•ng 8081 cá»§a container
EXPOSE 8081

# Lá»‡nh Ä‘á»ƒ khá»Ÿi cháº¡y á»©ng dá»¥ng (thay 'src/index.js' náº¿u cáº§n)
CMD [ "node", "src/server.js" ]