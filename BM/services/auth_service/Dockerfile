# ----------------------------------------------------
# GIAI ÄOáº N 1: DEPS (CÃ i dependencies Ä‘áº§y Ä‘á»§ Ä‘á»ƒ build)
# ----------------------------------------------------
FROM node:22-alpine AS deps
WORKDIR /app
COPY package*.json ./
# CÃ i Ä‘áº·t TOÃ€N Bá»˜ gÃ³i (cáº£ devDependencies)
RUN npm ci

# ----------------------------------------------------
# GIAI ÄOáº N 2: BUILDER (Generate Prisma Client)
# ----------------------------------------------------
FROM node:22-alpine AS builder
WORKDIR /app

# ğŸ”¥ [FIX QUAN TRá»ŒNG]: CÃ i openssl NGAY Táº I ÄÃ‚Y Ä‘á»ƒ táº£i Prisma Engine
RUN apk add --no-cache openssl ca-certificates

COPY --from=deps /app/node_modules ./node_modules
COPY . .

# ğŸ’¡ BÃ¢y giá» lá»‡nh nÃ y sáº½ cháº¡y mÆ°á»£t mÃ  vÃ¬ Ä‘Ã£ cÃ³ openssl
RUN npx prisma generate

# ----------------------------------------------------
# GIAI ÄOáº N 3: RUNNER (Production)
# ----------------------------------------------------
FROM node:22-alpine AS runner
WORKDIR /app

# CÃ i Ä‘áº·t openssl vÃ  dumb-init cho mÃ´i trÆ°á»ng cháº¡y
RUN apk add --no-cache openssl dumb-init

ENV NODE_ENV=production

# 1. Copy package.json
COPY package*.json ./

# 2. CÃ i Ä‘áº·t dependencies production
RUN npm ci --omit=dev

# 3. COPY QUAN TRá»ŒNG:
# Copy thÆ° má»¥c @prisma (chá»©a Ä‘á»‹nh nghÄ©a)
COPY --from=builder /app/node_modules/@prisma ./node_modules/@prisma
# Copy thÆ° má»¥c .prisma (chá»©a Client tháº­t vÃ  Binary engine Ä‘Ã£ generate)
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma

# Copy thÆ° má»¥c prisma (chá»©a schema)
COPY --from=builder /app/prisma ./prisma

# Copy source code
COPY --from=builder /app/src ./src
COPY --from=builder /app/server.js ./

# Chuyá»ƒn user
USER node

EXPOSE 8081

CMD ["dumb-init", "node", "server.js"]