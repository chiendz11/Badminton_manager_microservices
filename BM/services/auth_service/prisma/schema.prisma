generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

model User {
  id                    String              @id @default(uuid())
  email                 String              @unique
  username              String?             @unique
  role                  Role                @default(USER)
  
  passwordHash          String?             
  
  isActive              Boolean             @default(true)
  isVerified            Boolean             @default(false)

  // ğŸ’¡ TRÆ¯á»œNG ÄÃƒ CÃ“: Sá»‘ láº§n Ä‘Äƒng nháº­p tháº¥t báº¡i liÃªn tiáº¿p (dÃ¹ng Ä‘á»ƒ Ä‘áº¿m)
  failedLoginAttempts   Int                 @default(0) 

  // ğŸ’¡ TRÆ¯á»œNG Cáº¦N THÃŠM: Thá»i Ä‘iá»ƒm tÃ i khoáº£n bá»‹ khÃ³a cho Ä‘áº¿n khi nÃ o (náº¿u bá»‹ khÃ³a)
  lockoutUntil          DateTime?           // ThÃªm dáº¥u ? Ä‘á»ƒ cho phÃ©p NULL (optional)
  
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  externalIdentities    ExternalIdentity[]  
  sessions              Session[]
  refreshTokens         RefreshToken[]
  verificationTokens   VerificationToken[]
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  expiresAt DateTime
} 

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model ExternalIdentity {
  id                String    @id @default(uuid())
  userId            String    
  user              User      @relation(fields: [userId], references: [id])
  
  providerName      String    
  providerUserId    String    

  createdAt         DateTime  @default(now())

  // Má»—i ID tá»« má»—i nhÃ  cung cáº¥p chá»‰ thuá»™c vá» Má»˜T User.
  @@unique([providerName, providerUserId]) 
}

model VerificationToken {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  token     String    @unique // Token duy nháº¥t Ä‘Æ°á»£c gá»­i qua email
  expiresAt DateTime
  createdAt DateTime  @default(now())

  @@unique([userId, token])
}

model ServiceClient {
  id           String   @id @default(uuid())
  name         String   @unique        // TÃªn service, vÃ­ dá»¥: "service-a"
  clientId     String   @unique        // Giá»‘ng OAuth client_id
  clientSecret String                   // Secret Ä‘á»ƒ xÃ¡c thá»±c ná»™i bá»™
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
