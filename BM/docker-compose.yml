

services:
  # ----------------------------------------------------
  # 1. AUTH SERVICE
  # ----------------------------------------------------
  auth_service:
    build:
      context: ./services/auth_service
      dockerfile: Dockerfile
    container_name: auth_service
    expose:
      - "8081"
    environment:
      - NODE_ENV=${NODE_ENV}
      - PORT=${AUTH_PORT}
      
      # Database & JWT (Map từ biến AUTH_... sang tên biến code cần)
      - DATABASE_URL=${AUTH_DATABASE_URL}
      - JWT_SECRET=${AUTH_JWT_SECRET}
      - JWT_REFRESH_SECRET=${AUTH_JWT_REFRESH_SECRET}
      - JWT_EXPIRY=${AUTH_JWT_EXPIRY}
      - REFRESH_TOKEN_EXPIRY=${AUTH_REFRESH_TOKEN_EXPIRY}
      
      # Internal & Mail
      - API_GATEWAY_URL=${AUTH_API_GATEWAY_URL}
      - USER_SERVICE_INTERNAL_URL=${AUTH_USER_SERVICE_URL}
      - INTERNAL_JOB_SECRET=${AUTH_INTERNAL_JOB_SECRET}
      - EMAIL_USER=${AUTH_EMAIL_USER}
      - EMAIL_PASS=${AUTH_EMAIL_PASS}
      
      # Google OAuth
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_OAUTH_REDIRECT_URL=${GOOGLE_OAUTH_REDIRECT_URL}
      - FRONTEND_ORIGIN=${FRONTEND_ORIGIN}
    env_file:
      - .env
    restart: always
    depends_on:
      - user_service
    networks:
      - microservice_network
    logging: &default-logging
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ----------------------------------------------------
  # 2. USER SERVICE
  # ----------------------------------------------------
  user_service:
    build:
      context: ./services/user_service
      dockerfile: Dockerfile
    container_name: user_service
    expose:
      - "8085"
    environment:
      - NODE_ENV=${NODE_ENV}
      - PORT=${USER_PORT}
      
      # --- DATABASE ---
      # Code gọi DATABASE_URL -> Lấy giá trị USER_DATABASE_URL từ .env
      - DATABASE_URL=${USER_DATABASE_URL}
      
      # --- JWT ---
      - JWT_SECRET=${USER_JWT_SECRET}
      - JWT_REFRESH_SECRET=${USER_JWT_REFRESH_SECRET}
      - JWT_EXPIRY=${USER_JWT_EXPIRY}
      - REFRESH_TOKEN_EXPIRY=${USER_REFRESH_TOKEN_EXPIRY}
      
      # --- INTERNAL SERVICE URLs ---
      - API_GATEWAY_URL=${USER_API_GATEWAY_URL}
      - STORAGE_SERVICE_URL=${USER_STORAGE_SERVICE_URL}
      - INTERNAL_JOB_SECRET=${USER_INTERNAL_JOB_SECRET}
      
      # --- EMAIL (Gmail - Lưu ý khác với Auth dùng VNU Mail) ---
      - EMAIL_USER=${USER_EMAIL_USER}
      - EMAIL_PASS=${USER_EMAIL_PASS}
      
      # --- DEFAULT ASSETS ---
      - DEFAULT_AVATAR_FILE_ID=${DEFAULT_AVATAR_FILE_ID}
      - DEFAULT_AVATAR_URL=${DEFAULT_AVATAR_URL}
    env_file:
      - .env
    restart: always
    networks:
      - microservice_network
    logging: *default-logging

  # ----------------------------------------------------
  # 3. CENTER SERVICE
  # ----------------------------------------------------
  center_service:
    build:
      context: ./services/center_service
      dockerfile: Dockerfile
    container_name: center_service
    expose:
      - "5003"
    environment:
      - NODE_ENV=${NODE_ENV}
      
      # --- APP CONFIG ---
      # Code gọi PORT -> Lấy giá trị CENTER_PORT
      - PORT=${CENTER_PORT}
      
      # --- DATABASE ---
      # Code gọi MONGODB_URI -> Lấy giá trị CENTER_MONGO_URI
      - MONGODB_URI=${CENTER_MONGO_URI}
      
      # --- SECURITY & INTERNAL ---
      - INTERNAL_AUTH_SECRET=${CENTER_INTERNAL_AUTH_SECRET}
      - ALLOWED_INTERNAL_SERVICES=${CENTER_ALLOWED_SERVICES}
      
      # --- ASSETS & STORAGE ---
      # Lưu ý: Code gọi là DEFAULT_LOGO_FILE_ID, file env tổng gọi là CENTER_DEFAULT_LOGO_ID
      - DEFAULT_LOGO_FILE_ID=${CENTER_DEFAULT_LOGO_ID}
      
      # Code gọi STORAGE_SERVICE_URL -> Lấy giá trị CENTER_STORAGE_URL
      - STORAGE_SERVICE_URL=${CENTER_STORAGE_URL}
    env_file:
      - .env
    restart: always
    depends_on:
      - storage_service
    networks:
      - microservice_network
    logging: *default-logging

  # ----------------------------------------------------
  # 4. STORAGE SERVICE
  # ----------------------------------------------------
  storage_service:
    build:
      context: ./services/storage_service
      dockerfile: Dockerfile
    container_name: storage_service
    expose:
      - "5002"
    environment:
      - NODE_ENV=${NODE_ENV}
      
      # --- APP CONFIG ---
      - PORT=${STORAGE_PORT}
      - MONGODB_URI=${STORAGE_MONGO_URI}
      
      # --- SECURITY ---
      - INTERNAL_JOB_SECRET=${STORAGE_INTERNAL_JOB_SECRET}
      - ALLOWED_SERVICES=${STORAGE_ALLOWED_SERVICES}
      
      # --- CLOUDINARY (Tên biến thường giống nhau) ---
      - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
    env_file:
      - .env
    restart: always
    networks:
      - microservice_network
    logging: *default-logging

  # ----------------------------------------------------
  # 5. API GATEWAY (Cổng nội bộ)
  # ----------------------------------------------------
  api_gateway:
    build:
      context: ./api_gateway
      dockerfile: Dockerfile
    container_name: api_gateway
    # Chỉ Expose nội bộ cho Nginx gọi, không mở ra ngoài
    expose:
      - "8080"
    environment:
      - NODE_ENV=${NODE_ENV}
      - PORT=${GATEWAY_PORT}
      
      # --- SERVICE URLs MAPPING ---
      # Code (Trái) = Env tổng (Phải)
      - AUTH_SERVICE_URL=${GATEWAY_AUTH_URL}
      - BOOKING_SERVICE_URL=${GATEWAY_BOOKING_URL}
      - PAYMENT_SERVICE_URL=${GATEWAY_PAYMENT_URL}
      - REVIEW_SERVICE_URL=${GATEWAY_REVIEW_URL}
      - USER_SERVICE_URL=${GATEWAY_USER_URL}
      - CENTER_SERVICE_URL=${GATEWAY_CENTER_URL}
      - STORAGE_SERVICE_URL=${GATEWAY_STORAGE_URL}
      
      # --- SHARED CONFIG ---
      - JWT_SECRET=${SHARED_JWT_SECRET}
      - FRONTEND_ORIGIN=${FRONTEND_ORIGIN}
      - GOOGLE_OAUTH_REDIRECT_URL=${GOOGLE_OAUTH_REDIRECT_URL}
      - INTERNAL_AUTH_SECRET=${GATEWAY_INTERNAL_AUTH_SECRET}
    env_file:
      - .env
    restart: always
    depends_on:
      - auth_service
      - user_service
      - center_service
      - storage_service
      - booking_service
    networks:
      - microservice_network
    logging: *default-logging

  #booking service
  booking_service:
    build: ./services/booking_service # Đường dẫn đến folder chứa Dockerfile
    container_name: booking_service
    ports:
      - "8082:8082" # Map port ra ngoài để test local nếu cần
    environment:
      - NODE_ENV=${NODE_ENV}
      
      # --- APP CONFIG ---
      # Code gọi PORT -> Lấy giá trị BOOKING_PORT (8082)
      - PORT=${BOOKING_PORT}
      
      # --- DATABASE ---
      # Code gọi MONGO_URI -> Lấy giá trị BOOKING_MONGO_URI
      - MONGO_URI=${BOOKING_MONGO_URI}
      
      # --- PAYMENT GATEWAY (PayOS) ---
      # Các key này tên giống nhau giữa code và env tổng, nhưng vẫn map explicit cho chắc
      - PAYOS_CLIENT_ID=${PAYOS_CLIENT_ID}
      - PAYOS_API_KEY=${PAYOS_API_KEY}
      - PAYOS_CHECKSUM_KEY=${PAYOS_CHECKSUM_KEY}
    env_file:
      - .env
    networks:
      - microservice_network

  ngrok:
    image: ngrok/ngrok:latest
    container_name: ngrok_container
    restart: on-failure:5
    command: "http --domain=eliz-unrelinquishable-unpendulously.ngrok-free.dev booking_service:8082"
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    env_file:
      - .env
    networks:
      - microservice_network
    ports:
      - "4040:4040" # Ngrok web interface
    depends_on:
      - booking_service

  # ----------------------------------------------------
  # 6. NGINX (Cổng Public duy nhất + WAF)
  # ----------------------------------------------------
  nginx:
    build: 
      context: ./nginx
      dockerfile: Dockerfile
    container_name: bm_nginx
    # Mở cổng 80 ra ngoài Internet
    ports:
      - "80:80" 
    environment:
      # --- CẤU HÌNH WAF ---
      - MODSEC_RULE_ENGINE=On
      - PARANOIA=1
      # Tắt Proxy tự động để dùng file config riêng trong folder templates
      - PROXY=0
    volumes:
      # Mount file log audit để kiểm tra tấn công
      - ./nginx/modsec_audit.log:/var/log/modsec_audit.log
    restart: always
    depends_on:
      - api_gateway
    networks:
      - microservice_network

networks:
  microservice_network:
    driver: bridge